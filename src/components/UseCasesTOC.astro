---
import type { MarkdownHeading } from 'astro';
import { t, type Lang } from '../i18n/utils';

interface Props {
    headings: MarkdownHeading[];
    lang?: Lang;
}

const { headings, lang = 'es' } = Astro.props;
const h2Headings = headings.filter(h => h.depth === 2);
const home = lang === 'en' ? `${import.meta.env.BASE_URL}en/` : import.meta.env.BASE_URL;
---

<aside class="use-cases-toc">
    <div class="toc-content">
        <div class="toc-header">
            <span class="toc-title">{t('toc.onThisPage', lang)}</span>
        </div>

        <nav class="toc-nav">
            <ul class="toc-list">
                <li>
                    <a href={home} class="toc-item toc-back">
                        <svg class="back-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        {t('toc.backToHome', lang)}
                    </a>
                </li>
                {h2Headings.map((heading) => (
                    <li>
                        <a href={`#${heading.slug}`} class="toc-item" data-slug={heading.slug}>
                            {heading.text}
                        </a>
                    </li>
                ))}
            </ul>
        </nav>
    </div>
</aside>

<script>
    document.addEventListener('astro:page-load', () => {
        const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.use-cases-toc .toc-item[data-slug]');
        if (!tocLinks.length) return;

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        tocLinks.forEach(link => link.classList.remove('active'));
                        const activeLink = document.querySelector<HTMLAnchorElement>(
                            `.use-cases-toc .toc-item[data-slug="${entry.target.id}"]`
                        );
                        if (activeLink) activeLink.classList.add('active');
                    }
                });
            },
            { rootMargin: '-80px 0px -60% 0px', threshold: 0 }
        );

        tocLinks.forEach(link => {
            const slug = link.dataset.slug;
            if (slug) {
                const section = document.getElementById(slug);
                if (section) observer.observe(section);
            }
        });
    });
</script>

<style>
    .use-cases-toc {
        display: none;
    }

    @media (min-width: 1024px) {
        .use-cases-toc {
            display: block;
            width: 18rem;
            min-width: 18rem;
            height: calc(100vh - 74px);
            position: sticky;
            top: 74px;
            overflow-y: auto;
            border-left: 2px solid var(--arch-ink);
            background-color: var(--arch-paper);
        }
    }

    .toc-content {
        padding: 1.5rem;
    }

    .toc-header {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--arch-line);
    }

    .toc-title {
        font-family: var(--font-heading);
        font-weight: 800;
        text-transform: uppercase;
        color: var(--arch-ink);
        font-size: 0.8rem;
        letter-spacing: 0.05em;
    }

    .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .toc-item {
        display: block;
        padding: 0.3rem 0.5rem;
        font-family: var(--font-body);
        font-size: 0.8125rem;
        color: var(--arch-ink-light);
        text-decoration: none;
        border-left: 2px solid transparent;
        transition: all 0.2s;
        line-height: 1.4;
    }

    .toc-item:hover {
        color: var(--arch-brick);
        background-color: rgba(231, 229, 223, 0.3);
    }

    .toc-item.active {
        color: var(--arch-brick);
        border-left-color: var(--arch-brick);
        font-weight: 600;
    }

    .toc-back {
        display: inline-flex;
        align-items: center;
        font-family: var(--font-mono);
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }

    .back-icon {
        width: 0.875rem;
        height: 0.875rem;
        margin-right: 0.375rem;
    }
</style>

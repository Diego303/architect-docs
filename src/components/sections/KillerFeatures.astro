---
import FeatureCard from '../ui/FeatureCard.astro';
import CodeFigure from '../ui/CodeFigure.astro';
import { t, type Lang } from '../../i18n/utils';
import { ui } from '../../i18n/ui';

interface Props { lang?: Lang; }
const { lang = 'es' } = Astro.props;

const features = ui[lang].features.items;

const iconPaths = [
    "M8 7h12M8 12h12M8 17h12M4 7h.01M4 12h.01M4 17h.01",
    "M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15",
    "M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10",
    "M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z",
    "M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z",
    "M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4",
    "M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
    "M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z",
];
---

<section id="features" class="features-section">
    <div class="features-container">
        <div class="section-header">
            <h2 class="section-title">{t('features.title', lang)}</h2>
            <div class="section-line"></div>
        </div>

        <div class="features-grid">
            {features.map((feature, i) => (
                <FeatureCard title={feature.title} iconPath={iconPaths[i]}>
                    <p>{feature.description}</p>
                </FeatureCard>
            ))}
        </div>

        <!-- Spotlight: Ralph Loop -->
        <div class="feature-spotlight">
            <div class="spotlight-text">
                <h3 class="spotlight-title">{t('features.ralphTitle', lang)}</h3>
                <p class="spotlight-desc" set:html={t('features.ralphDesc1', lang)} />
                <p class="spotlight-desc" set:html={t('features.ralphDesc2', lang)} />
                <div class="spotlight-cmd">
                    <code>$ architect loop "Implementa el módulo de pagos" \<br/>  --check "pytest tests/ -q" \<br/>  --check "ruff check src/" \<br/>  --max-iterations 25</code>
                </div>
            </div>
            <CodeFigure title={t('features.ralphFigureTitle', lang)}>
                <div class="sl-line"><span class="sl-icon">&#x1F504;</span> {t('features.ralphLine1', lang)}</div>
                <div class="sl-line sl-indent"><span class="sl-icon-sm">&#x1F527;</span> edit_file &#x2192; src/payments/stripe.py</div>
                <div class="sl-line sl-indent"><span class="sl-icon-sm">&#x1F527;</span> edit_file &#x2192; tests/test_payments.py</div>
                <div class="sl-line sl-indent"><span class="sl-check">&#x2713;</span> {t('features.ralphLine2', lang)}</div>
                <div class="sl-spacer"></div>
                <div class="sl-line"><span class="sl-icon">&#x1F9EA;</span> {t('features.ralphVerification', lang)}</div>
                <div class="sl-line sl-indent"><span class="sl-check">&#x2713;</span> pytest tests/ -q &#x2192; <span class="sl-pass">{t('features.ralphTestPass', lang)}</span></div>
                <div class="sl-line sl-indent"><span class="sl-check">&#x2713;</span> ruff check src/ &#x2192; <span class="sl-pass">{t('features.ralphLintPass', lang)}</span></div>
                <div class="sl-separator"></div>
                <div class="sl-line sl-bold"><span class="sl-icon">&#x2705;</span> {t('features.ralphDone', lang)} (<span class="sl-cost">$0.089</span>)</div>
            </CodeFigure>
        </div>

        <!-- Spotlight: Guardrails & Quality Gates -->
        <div class="feature-spotlight spotlight-reverse">
            <div class="spotlight-text">
                <h3 class="spotlight-title">{t('features.guardrailsTitle', lang)}</h3>
                <p class="spotlight-desc" set:html={t('features.guardrailsDesc1', lang)} />
                <p class="spotlight-desc" set:html={t('features.guardrailsDesc2', lang)} />
            </div>
            <CodeFigure title="guardrails.yaml">
                <div class="sl-yaml"><span class="sl-key">guardrails:</span></div>
                <div class="sl-yaml sl-yi1"><span class="sl-key">protected_files:</span> [".env", "*.pem", "migrations/*"]</div>
                <div class="sl-yaml sl-yi1"><span class="sl-key">blocked_commands:</span> ['rm -rf /', 'git push --force']</div>
                <div class="sl-yaml sl-yi1"><span class="sl-key">max_files_modified:</span> 30</div>
                <div class="sl-spacer-sm"></div>
                <div class="sl-yaml sl-yi1"><span class="sl-key">quality_gates:</span></div>
                <div class="sl-yaml sl-yi2">- <span class="sl-key">name:</span> lint</div>
                <div class="sl-yaml sl-yi3"><span class="sl-key">command:</span> "ruff check src/"</div>
                <div class="sl-yaml sl-yi3"><span class="sl-key">required:</span> true</div>
                <div class="sl-yaml sl-yi2">- <span class="sl-key">name:</span> tests</div>
                <div class="sl-yaml sl-yi3"><span class="sl-key">command:</span> "pytest tests/ -q"</div>
                <div class="sl-yaml sl-yi3"><span class="sl-key">required:</span> true</div>
                <div class="sl-spacer-sm"></div>
                <div class="sl-yaml sl-yi1"><span class="sl-key">code_rules:</span></div>
                <div class="sl-yaml sl-yi2">- <span class="sl-key">pattern:</span> 'eval\('</div>
                <div class="sl-yaml sl-yi3"><span class="sl-key">severity:</span> <span class="sl-val">block</span></div>
            </CodeFigure>
        </div>

        <!-- Spotlight: Parallel Runs -->
        <div class="feature-spotlight">
            <div class="spotlight-text">
                <h3 class="spotlight-title">{t('features.parallelTitle', lang)}</h3>
                <p class="spotlight-desc" set:html={t('features.parallelDesc1', lang)} />
                <p class="spotlight-desc" set:html={t('features.parallelDesc2', lang)} />
                <div class="spotlight-cmd">
                    <code>$ architect parallel "Refactoriza el módulo auth" \<br/>  --models gpt-4.1,claude-sonnet-4,deepseek-chat</code>
                </div>
            </div>
            <CodeFigure title={t('features.parallelFigureTitle', lang)}>
                <div class="sl-line sl-bold">Worker 1 <span class="sl-meta">(gpt-4.1)</span></div>
                <div class="sl-line sl-indent">&#x2192; architect/parallel-1 <span class="sl-pass">&#x2713;</span>  8 {t('features.parallelSteps', lang)}  <span class="sl-cost">$0.034</span></div>
                <div class="sl-spacer-sm"></div>
                <div class="sl-line sl-bold">Worker 2 <span class="sl-meta">(claude-sonnet-4)</span></div>
                <div class="sl-line sl-indent">&#x2192; architect/parallel-2 <span class="sl-pass">&#x2713;</span>  5 {t('features.parallelSteps', lang)}  <span class="sl-cost">$0.028</span></div>
                <div class="sl-spacer-sm"></div>
                <div class="sl-line sl-bold">Worker 3 <span class="sl-meta">(deepseek-chat)</span></div>
                <div class="sl-line sl-indent">&#x2192; architect/parallel-3 <span class="sl-pass">&#x26A1;</span> 20 {t('features.parallelSteps', lang)}  <span class="sl-cost">$0.006</span></div>
                <div class="sl-separator"></div>
                <div class="sl-line"><span class="sl-meta">$ architect diff parallel-1 parallel-2</span></div>
                <div class="sl-line"><span class="sl-meta">$ architect merge parallel-2</span></div>
            </CodeFigure>
        </div>
    </div>
</section>

<style>
    .features-section {
        max-width: 80rem;
        margin: 0 auto;
        padding: 5rem 1.5rem;
        border-top: 2px solid var(--arch-line);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .section-title {
        font-family: var(--font-heading);
        font-size: 1.875rem;
        color: var(--arch-ink);
        font-weight: 800;
        margin: 0;
        white-space: nowrap;
    }

    @media (max-width: 640px) {
        .section-title {
            white-space: normal;
            font-size: 1.5rem;
        }
    }

    .section-line {
        height: 4px;
        background-color: var(--arch-ink);
        flex-grow: 1;
    }

    .features-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 4rem;
    }

    @media (min-width: 768px) {
        .features-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1280px) {
        .features-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    /* Feature Spotlights */
    .feature-spotlight {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2.5rem;
        align-items: start;
        background-color: var(--arch-surface);
        border: 2px solid var(--arch-ink);
        padding: 2.5rem;
        box-shadow: var(--shadow-draft);
        margin-bottom: 3rem;
    }

    @media (min-width: 1024px) {
        .feature-spotlight {
            grid-template-columns: 1fr 1fr;
        }

        .feature-spotlight.spotlight-reverse .spotlight-text {
            order: 2;
        }
    }

    .spotlight-title {
        font-family: var(--font-heading);
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--arch-ink);
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin: 0 0 1rem 0;
    }

    .spotlight-desc {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--arch-ink-light);
        margin: 0 0 1rem 0;
    }

    .spotlight-desc strong {
        color: var(--arch-brick);
        font-weight: 600;
    }

    .spotlight-desc code {
        font-family: var(--font-mono);
        font-size: 0.875rem;
        background-color: var(--arch-shape);
        padding: 0.125rem 0.375rem;
        border: 1px solid var(--arch-line);
    }

    .spotlight-cmd {
        margin-top: 1.25rem;
    }

    .spotlight-cmd code {
        display: block;
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        color: var(--arch-ink);
        background-color: var(--arch-shape);
        padding: 0.75rem 1rem;
        border: 1px solid var(--arch-line);
        line-height: 1.7;
    }

    /* Spotlight log lines */
    .sl-line {
        padding: 0.125rem 0;
    }

    .sl-indent {
        padding-left: 1.5rem;
    }

    .sl-bold {
        font-weight: 700;
    }

    .sl-icon {
        margin-right: 0.375rem;
    }

    .sl-icon-sm {
        margin-right: 0.25rem;
        font-size: 0.8125rem;
    }

    .sl-check {
        color: var(--arch-ink);
        font-weight: 700;
        margin-right: 0.25rem;
    }

    .sl-pass {
        color: var(--arch-brick);
        font-weight: 500;
    }

    .sl-cost {
        color: var(--arch-brick);
        font-weight: 600;
    }

    .sl-meta {
        color: var(--arch-ink-light);
        font-size: 0.8125rem;
    }

    .sl-spacer {
        height: 0.75rem;
    }

    .sl-spacer-sm {
        height: 0.375rem;
    }

    .sl-separator {
        border-top: 1px dashed var(--arch-line);
        margin: 0.75rem 0;
    }

    /* YAML styling in spotlights */
    .sl-yaml {
        padding: 0.0625rem 0;
    }

    .sl-yi1 { padding-left: 1rem; }
    .sl-yi2 { padding-left: 2rem; }
    .sl-yi3 { padding-left: 3rem; }

    .sl-key {
        color: var(--arch-brick);
        font-weight: 500;
    }

    .sl-val {
        color: var(--arch-ink);
        font-weight: 700;
    }
</style>
